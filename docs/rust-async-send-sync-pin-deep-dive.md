# Rust å¹¶å‘å®‰å…¨ï¼ˆSend/Sync/Pinï¼‰ä¸ async çŠ¶æ€æœºæ·±åº¦è§£æ

é¢å‘åœºæ™¯ï¼šä½ åœ¨å®ç°ç½‘ç»œè½¬å‘ï¼ˆå¦‚ pb-mapperï¼‰æ—¶éœ€è¦ç†è§£ **ä¸ºä»€ä¹ˆæŸäº› future å¿…é¡» `Send + 'static`**ã€ä¸ºä»€ä¹ˆ `async fn` èƒ½è·¨ `.await` æŒæœ‰å€Ÿç”¨ã€ä»¥åŠ `Pin` å¦‚ä½•ä¿è¯è‡ªå¼•ç”¨å®‰å…¨ã€‚

> **Code Version**: pb-mapper æœ¬åœ°å·¥ä½œåŒºï¼ˆ2026-01-17ï¼‰

## 1. å¼•è¨€ï¼šé—®é¢˜ä»å“ªé‡Œæ¥
å¼‚æ­¥ç½‘ç»œç³»ç»Ÿé€šå¸¸ä¼šåšä¸¤ç±»äº‹æƒ…ï¼š
1) åœ¨å½“å‰ä»»åŠ¡ä¸­ç›´æ¥ `.await` ä¸€æ®µ I/O é€»è¾‘ï¼›
2) æŠŠä¸€æ®µ I/O é€»è¾‘ä¸¢è¿› `tokio::spawn` äº¤ç»™è¿è¡Œæ—¶è°ƒåº¦ã€‚

è¿™ä¸¤ç±»è·¯å¾„çš„ **å®‰å…¨è¾¹ç•Œä¸åŒ**ï¼š
- ç›´æ¥ `.await`ï¼šåªéœ€ä¿è¯**ç”Ÿå‘½å‘¨æœŸæœ‰æ•ˆ**ï¼›
- `tokio::spawn`ï¼šå¿…é¡»æ»¡è¶³ **`Send + 'static`**ã€‚

è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ pb-mapper åœ¨ `StreamForward` ä¸Šå¿…é¡»ä¿è¯ Sendï¼ˆè§ `forward_local_to_remote`ï¼‰ï¼Œå¦åˆ™ `tokio::spawn` ä¼šæ‹’ç»ç¼–è¯‘ã€‚`tokio::spawn` çš„è°ƒç”¨ç‚¹åœ¨æœ¬é¡¹ç›®çš„ client/server ä¾§éƒ½èƒ½çœ‹åˆ°ã€‚`src/local/client/mod.rs:164`ã€`src/local/server/mod.rs:309`ã€‚

> ğŸ’¡ **Key Point**ï¼š
> â€œèƒ½ä¸èƒ½ awaitâ€ ä¸ â€œèƒ½ä¸èƒ½ spawnâ€ æ˜¯ä¸¤å¥—ä¸åŒçš„å®‰å…¨çº¦æŸã€‚å‰è€…å…³æ³¨ç”Ÿå‘½å‘¨æœŸï¼Œåè€…å…³æ³¨è·¨çº¿ç¨‹ä¸è·¨æ ˆå¸§å­˜æ´»ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬ä»åº•å±‚å¹¶å‘å®‰å…¨è§’åº¦è§£é‡Š **Send / Sync / Pin / async çŠ¶æ€æœº**ï¼Œå¹¶ç»“åˆ pb-mapper çš„çœŸå®ä»£ç è¯´æ˜ã€‚

### 1.1 é˜…è¯»è·¯çº¿ï¼ˆå»ºè®®ï¼‰
- **å…ˆè¯» Â§3 å’Œ Â§6**ï¼šç†è§£ async çŠ¶æ€æœºä¸ Pinï¼Œå»ºç«‹å¿ƒæ™ºæ¨¡å‹  
- **å†è¯» Â§4/Â§5**ï¼šç†è§£ Send/'static ä¸ spawn çº¦æŸ  
- **æœ€åè¯» Â§8~Â§10**ï¼šè½åœ°åˆ° split/into_split çš„å·¥ç¨‹å†³ç­–  

### 1.2 æ€»ä½“æµç¨‹å›¾ï¼ˆä»æ¦‚å¿µåˆ°çº¦æŸï¼‰
```
async fn
  â””â”€ ç¼–è¯‘ä¸ºçŠ¶æ€æœº (Future)
       â”œâ”€ .await -> éœ€è¦ Pin ä¿è¯åœ°å€ç¨³å®š
       â””â”€ spawn? -> éœ€è¦ Send + 'static
```

---

## 2. èƒŒæ™¯ä¸æœ¯è¯­ï¼ˆå…ˆç»Ÿä¸€è¯­è¨€ï¼‰

### 2.1 æœ¯è¯­é€ŸæŸ¥
> ğŸ“ **Terminology**
> - **Send**ï¼šä¸€ä¸ªå€¼èƒ½å¦å®‰å…¨åœ°è·¨çº¿ç¨‹ç§»åŠ¨ã€‚
> - **Sync**ï¼šä¸€ä¸ªç±»å‹çš„å…±äº«å¼•ç”¨ï¼ˆ`&T`ï¼‰èƒ½å¦è·¨çº¿ç¨‹å…±äº«ã€‚
> - **'static**ï¼šå€¼ä¸å«å¯¹æ ˆå¸§çš„å€Ÿç”¨ï¼›å¯åœ¨ç¨‹åºä»»æ„æ—¶åˆ»å­˜åœ¨ã€‚
> - **Pin**ï¼šä¿è¯å†…å­˜ä½ç½®å›ºå®šï¼Œç”¨äºè‡ªå¼•ç”¨å®‰å…¨ã€‚
> - **Future çŠ¶æ€æœº**ï¼š`async fn` ç¼–è¯‘åçš„ç»“æ„ä½“ï¼Œå†…éƒ¨ä¿å­˜è·¨ `.await` éœ€è¦çš„å˜é‡ã€‚

### 2.2 Send/Sync/'static çš„å…³ç³»
å®ƒä»¬æ˜¯ **æ­£äº¤çº¦æŸ**ï¼š
- `Send` ä¸ä»£è¡¨ `'static`ï¼ˆå¯ä»¥ Send ä½†å¸¦å€Ÿç”¨ï¼‰ã€‚
- `'static` ä¸ä»£è¡¨ `Send`ï¼ˆæ¯”å¦‚å†…éƒ¨å« `Rc`ï¼‰ã€‚
- `Sync` é’ˆå¯¹å…±äº«å¼•ç”¨ï¼Œ`Send` é’ˆå¯¹æ‰€æœ‰æƒç§»åŠ¨ã€‚

> âš ï¸ **Gotcha**ï¼š
> â€œæœ‰æ‰€æœ‰æƒå°±ä¸éœ€è¦è¯æ˜ Sendâ€æ˜¯é”™è¯¯çš„ã€‚æ‰€æœ‰æƒåªè®© `'static` æ›´å®¹æ˜“æˆç«‹ï¼Œä½† **ä»ç„¶è¦æ»¡è¶³ Send**ã€‚

### 2.3 å‰ç½®çŸ¥è¯†ï¼ˆå»ºè®®ï¼‰
- Rust move/borrow çš„åŸºæœ¬è§„åˆ™  
- `async/await` çš„è¯­æ³•ä¸ `.await` æš‚åœç‚¹æ¦‚å¿µ  
- `tokio::spawn` ä¸æ‰§è¡Œå™¨çš„åŸºæœ¬æ¨¡å‹  

---

## 3. async çš„â€œæ ˆå¸§â€åˆ°åº•æ˜¯ä»€ä¹ˆ
æœ¬è´¨ï¼š**async fn ä¼šè¢«ç¼–è¯‘æˆä¸€ä¸ªçŠ¶æ€æœºç»“æ„ä½“**ã€‚æ¯ä¸ª `.await` æ˜¯ä¸€ä¸ªçŠ¶æ€ï¼Œè·¨ `.await` å­˜æ´»çš„å±€éƒ¨å˜é‡ä¼šå˜æˆå­—æ®µã€‚

### 3.0 Overviewï¼šå¼‚æ­¥è°ƒåº¦å¾ªç¯
```
executor.poll(future)
   â”œâ”€ Ready  -> å®Œæˆ
   â””â”€ Pending -> æ³¨å†Œ waker -> ç­‰å¾… I/O -> å†æ¬¡ poll
```
è¿™ä¸ªå¾ªç¯å†³å®šäº†ï¼šfuture ä¼šè¢«åå¤ pollï¼Œå› æ­¤éœ€è¦**ç¨³å®šåœ°å€**ï¼ˆPinï¼‰ä¸**æ˜ç¡®çš„ç”Ÿå‘½å‘¨æœŸè¾¹ç•Œ**ï¼ˆ'static/å€Ÿç”¨ï¼‰ã€‚

### 3.1 çŠ¶æ€æœºçš„ç›´è§‚æ¨¡å‹
```
async fn f() {
    let mut x = 1;
    foo().await;
    x += 1;
}

==> çŠ¶æ€æœºï¼ˆä¼ªç»“æ„ï¼‰

struct F { state: State, x: u64, inner: Option<FooFuture> }
```

- `x` éœ€è¦è·¨ `.await` æ´»ç€ï¼Œæ‰€ä»¥å˜æˆå­—æ®µã€‚
- `inner` ä¿å­˜ `foo().await` çš„ futureã€‚

> ğŸ’¡ **Key Point**ï¼š
> async çš„â€œæ ˆå¸§â€å°±æ˜¯è¿™ä¸ªçŠ¶æ€æœºç»“æ„ä½“ï¼Œä¸æ˜¯ OS çº¿ç¨‹æ ˆã€‚

### 3.2 ä¸ºä»€ä¹ˆ `.await` åå€Ÿç”¨ä»æœ‰æ•ˆ
å¦‚æœä¸€ä¸ª future åœ¨ `.await` æœŸé—´æŒæœ‰å€Ÿç”¨ï¼Œåªè¦ **å¤–å±‚çŠ¶æ€æœºè¿˜æ´»ç€**ï¼Œå€Ÿç”¨å°±æœ‰æ•ˆã€‚å› ä¸ºçŠ¶æ€æœºæœ¬èº«è¢« Pin ä½ï¼Œä¸ä¼šç§»åŠ¨ã€‚

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨ pb-mapper é‡Œ **ç›´æ¥ `.await`** `forward_local_to_remote(...)` æ˜¯åˆæ³•çš„ï¼šå®ƒæŒæœ‰äº† `split()` çš„å€Ÿç”¨åŠè¾¹ï¼Œä½†å¤–å±‚ä»»åŠ¡è¿˜æ´»ç€ï¼Œæ‰€ä»¥ç”Ÿå‘½å‘¨æœŸæ˜¯å®‰å…¨çš„ã€‚

> â­ï¸ æ¥ä¸‹æ¥æˆ‘ä»¬æŠŠâ€œç”Ÿå‘½å‘¨æœŸå®‰å…¨â€æ‰©å±•åˆ°â€œè·¨çº¿ç¨‹å®‰å…¨â€ï¼Œå¼•å‡º Send/Sync ä¸ spawn çº¦æŸã€‚

---

## 4. Sendï¼šè·¨çº¿ç¨‹ç§»åŠ¨ä¸ºä»€ä¹ˆéœ€è¦è¯æ˜

### 4.1 Send çš„â€œå¹¶å‘å®‰å…¨â€å«ä¹‰
`Send` çš„æ ¸å¿ƒæ˜¯ï¼š**æŠŠå€¼ç§»åŠ¨åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ä¸ä¼šå¯¼è‡´æ•°æ®ç«äº‰æˆ–æ‚¬å‚å¼•ç”¨**ã€‚

- `Rc<T>` ä¸æ˜¯ Sendï¼šå®ƒçš„å¼•ç”¨è®¡æ•°ä¸æ˜¯åŸå­æ“ä½œã€‚
- `Arc<T>` æ˜¯ Sendï¼šå¼•ç”¨è®¡æ•°æ˜¯åŸå­æ“ä½œã€‚

### 4.2 â€œSend ä½†é 'staticâ€ çš„ä¾‹å­
```rust
fn make_future<'a>(x: &'a mut u64) -> impl Future<Output=()> + Send + 'a {
    async move { *x += 1; }
}
```
- è¿™ä¸ª future **ä¸æ˜¯ `'static`**ï¼Œå› ä¸ºå®ƒå€Ÿç”¨ `x`ã€‚
- ä½†å®ƒä»å¯ `Send`ï¼Œå› ä¸º `&mut u64` è·¨çº¿ç¨‹ç§»åŠ¨æ˜¯å®‰å…¨çš„ï¼ˆç”Ÿå‘½å‘¨æœŸä»ç”±è°ƒç”¨æ–¹ä¿è¯ï¼‰ã€‚

> ğŸ¤” **Think About**ï¼š
> â€œè·¨çº¿ç¨‹ç§»åŠ¨â€ä¸â€œèƒ½æ´»å¤šä¹…â€å®Œå…¨æ˜¯ä¸¤ä¸ªé—®é¢˜ã€‚

> â­ï¸ ä¸‹ä¸€èŠ‚ä¼šè§£é‡Šï¼šä¸ºä»€ä¹ˆ `tokio::spawn` åŒæ—¶è¦æ±‚ `Send + 'static`ï¼Œè€Œä¸æ˜¯åªè¦å…¶ä¸­ä¹‹ä¸€ã€‚

---

## 5. ä¸ºä»€ä¹ˆ `tokio::spawn` éœ€è¦ `Send + 'static`

### 5.1 `spawn` çš„çº¦æŸæ¥æº
`tokio::spawn` ä¼šæŠŠä»»åŠ¡äº¤ç»™è¿è¡Œæ—¶è°ƒåº¦ï¼š
- ä»»åŠ¡å¯èƒ½åœ¨**ä»»æ„çº¿ç¨‹**æ‰§è¡Œï¼ˆéœ€è¦ `Send`ï¼‰
- ä»»åŠ¡å¯èƒ½åœ¨å½“å‰å‡½æ•°è¿”å›åç»§ç»­å­˜åœ¨ï¼ˆéœ€è¦ `'static`ï¼‰

å› æ­¤è¦æ±‚ï¼š`Future + Send + 'static`ã€‚

### 5.2 pb-mapper é‡Œçš„å®é™…è°ƒç”¨ç‚¹
åœ¨ pb-mapper ä¸­ï¼Œ`tokio::spawn` åŒ…è£¹äº† `handle_local_stream` / `handle_stream`ï¼š
- `src/local/client/mod.rs:164`
- `src/local/server/mod.rs:309`

è¿™äº› async å‡½æ•°å†…éƒ¨ä¼š `.await StreamForward::forward_local_to_remote`ï¼Œå› æ­¤ **forward çš„ future å¿…é¡»æ˜¯ Send**ï¼Œå¦åˆ™å¤–å±‚ä»»åŠ¡å°±ä¸æ˜¯ Sendã€‚

> âš ï¸ **Gotcha**ï¼š
> â€œåªè¦ forward æœ¬èº«æ˜¯ async å°±è¡Œâ€æ˜¯é”™çš„ã€‚**å®ƒå¿…é¡»æ»¡è¶³å¤–å±‚ spawn å¯¹ Send çš„è¦æ±‚**ã€‚

> â­ï¸ ä¸‹é¢è¿›å…¥ Pinï¼šå³ä½¿æ»¡è¶³ Send/'staticï¼Œasync ä»éœ€è¦ Pin æ¥ä¿éšœâ€œåœ°å€ç¨³å®šâ€ã€‚

---

## 6. Pinï¼šä¸ºä»€ä¹ˆ async éœ€è¦å®ƒ
ç®€è¿°ï¼š`Pin` ä¸æ˜¯â€œé”â€ï¼Œè€Œæ˜¯**å¯¹â€œæ˜¯å¦å…è®¸ç§»åŠ¨â€çš„ç¼–è¯‘æœŸçº¦æŸ**ã€‚async çŠ¶æ€æœºä¹‹æ‰€ä»¥éœ€è¦å®ƒï¼Œæ˜¯å› ä¸ºç¼–è¯‘å™¨ä¼šç”Ÿæˆå¯èƒ½**è‡ªå¼•ç”¨**çš„ç»“æ„ä½“ï¼Œè€Œè‡ªå¼•ç”¨ä¸€æ—¦ç§»åŠ¨åœ°å€å°±ä¼šå¤±æ•ˆã€‚

### 6.0 Overviewï¼šPin ä¸ poll API çš„å…³ç³»
åœ¨ Rust async I/O é‡Œï¼Œæ ¸å¿ƒ trait çš„ poll æ–¹æ³•éƒ½è¦æ±‚ `Pin<&mut Self>`ã€‚è¿™æ˜¯ä¸€ç§â€œå¼ºåˆ¶å¼€å‘è€…æ‰¿è®¤åœ°å€ç¨³å®šæ€§â€çš„ API è®¾è®¡ï¼š

```rust
trait AsyncRead {
    fn poll_read(
        self: Pin<&mut Self>,
        cx: &mut Context<'_>,
        buf: &mut ReadBuf<'_>,
    ) -> Poll<Result<()>>;
}
```

è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆ uni-stream çš„ `UdpStreamReadHalf`/`UdpStream` å®ç°é‡Œï¼Œ`poll_read` çš„ç­¾åéƒ½æ˜¯ `Pin<&mut Self>`ï¼ˆ`deps/uni-stream/src/udp.rs:527`ã€`deps/uni-stream/src/udp.rs:585`ï¼‰ã€‚  
**poll éœ€è¦ Pin çš„æ ¹å› ï¼šæ‰§è¡Œå™¨ä¼šåå¤ pollï¼Œä¸èƒ½è®© self çš„åœ°å€åœ¨ poll ä¹‹é—´å˜åŒ–ã€‚**

### 6.1 Overviewï¼šè‡ªå¼•ç”¨ä¸ºä»€ä¹ˆä¼šå‡ºç°
async çŠ¶æ€æœºå¸¸å¸¸â€œå†…éƒ¨æŒæœ‰å¯¹è‡ªèº«å­—æ®µçš„å€Ÿç”¨â€ã€‚ä¾‹å¦‚å¤–å±‚ future æŒæœ‰ `inner`ï¼Œè€Œ `inner` åˆå€Ÿç”¨å¤–å±‚çš„ `x`ï¼š

```
[å †ä¸Šçš„ Task]
+--------------------+
| Outer Future       |
|  - x: u64          |
|  - inner: &x ----- |----> (æŒ‡å‘åŒä¸€å—å†…å­˜)
+--------------------+
```

ä¸€æ—¦ `Outer Future` è¢«ç§»åŠ¨åˆ°æ–°åœ°å€ï¼Œ`inner` é‡Œçš„å¼•ç”¨å°±æ‚¬å‚ã€‚

> ğŸ’¡ **Key Point**ï¼š
> Pin çš„ç›®æ ‡ä¸æ˜¯â€œç¦æ­¢ä¿®æ”¹â€ï¼Œè€Œæ˜¯**ä¿è¯åœ°å€ç¨³å®š**ï¼Œä»è€Œè®©è¿™ç§ç¼–è¯‘å™¨ç”Ÿæˆçš„è‡ªå¼•ç”¨åˆæ³•ã€‚

### 6.2 ä»€ä¹ˆæ—¶å€™ä¼šå‘ç”Ÿâ€œç§»åŠ¨â€ï¼Ÿ
åœ¨ Rust é‡Œï¼Œâ€œç§»åŠ¨â€æ˜¯é»˜è®¤è¯­ä¹‰ã€‚**åªè¦ä½ æŠŠå€¼æŒ‰å€¼ä¼ é€’ã€èµ‹å€¼ã€æ”¾è¿›å®¹å™¨æˆ–ä»å‡½æ•°è¿”å›ï¼Œéƒ½ä¼šå‘ç”Ÿç§»åŠ¨**ã€‚

```rust
let a = String::from("hello");
let b = a;            // moveï¼ša è¢«ç§»åŠ¨åˆ° b

fn take(x: String) {} // move into function
take(b);

let mut v = Vec::new();
v.push(String::from("x")); // move into Vec
```

è¿˜æœ‰ä¸€ç§æ›´éšè”½çš„ç§»åŠ¨ï¼š**å®¹å™¨æ‰©å®¹**ã€‚ä¾‹å¦‚ Vec åœ¨æ‰©å®¹æ—¶ä¼šæ¬è¿å…ƒç´ ã€‚

```rust
let mut v = Vec::with_capacity(1);
v.push(String::from("a"));
v.push(String::from("b")); // å¯èƒ½è§¦å‘ reallocate -> å…ƒç´ æ•´ä½“ç§»åŠ¨
```

> âš ï¸ **Gotcha**ï¼š
> â€œæˆ‘æ²¡æœ‰æ˜¾å¼ç§»åŠ¨ï¼Œæ‰€ä»¥ä¸ä¼šç§»åŠ¨â€æ˜¯é”™çš„ã€‚Rust çš„ç§»åŠ¨æ˜¯é»˜è®¤è¯­ä¹‰ã€‚

### 6.3 Pin æ˜¯â€œæ€ä¹ˆåšåˆ°ä¸è¢«ç§»åŠ¨â€çš„ï¼Ÿ
Pin ä¸æ˜¯è¿è¡Œæ—¶é”ï¼Œè€Œæ˜¯**ç±»å‹ç³»ç»Ÿ + API çº¦æŸ**ï¼š

- `Pin<&mut T>` å¯¹ **`T: !Unpin`** çš„ç±»å‹ï¼Œä¸å…è®¸ä½ æ‹¿åˆ°æ™®é€šçš„ `&mut T`ã€‚  
  ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ æ— æ³•è°ƒç”¨ä¼šç§»åŠ¨ `T` çš„ APIï¼ˆæ¯”å¦‚ `mem::replace`ï¼‰ã€‚
- åªæœ‰åœ¨ `T: Unpin` æ—¶ï¼Œ`Pin` æ‰â€œé€€åŒ–â€ä¸ºæ™®é€šå¼•ç”¨ã€‚

ç¤ºä¾‹ï¼š
```rust
use std::pin::Pin;

async fn work() {}

let mut fut = Box::pin(work()); // Pin<Box<Future>>

// âŒ ä¸èƒ½æŠŠ pinned future æ•´ä½“æ‹¿å‡ºæ¥ç§»åŠ¨
// let moved = *fut;

// âœ… å¯ä»¥å®‰å…¨åœ° pollï¼Œå› ä¸º poll æ¥å— Pin<&mut T>
```

> ğŸ’¡ **Key Point**ï¼š
> Pin ä¸æ˜¯ç¦æ­¢â€œæ‰€æœ‰æ“ä½œâ€ï¼Œè€Œæ˜¯**ç¦æ­¢ä¼šå¯¼è‡´åœ°å€å˜åŒ–çš„æ“ä½œ**ã€‚

### 6.4 Unpinï¼šPin ä»€ä¹ˆæ—¶å€™â€œå¤±æ•ˆâ€
å¤§å¤šæ•°æ™®é€šç±»å‹éƒ½å®ç°äº† `Unpin`ï¼Œè¿™æ„å‘³ç€å®ƒä»¬â€œå³ä½¿è¢« Pin äº†ï¼Œä¹Ÿå¯ä»¥å®‰å…¨ç§»åŠ¨â€ã€‚

```rust
use std::pin::Pin;

let mut x = 123u64;
let mut p = Pin::new(&mut x); // u64: Unpin

// ä½ ä»ç„¶å¯ä»¥æ‹¿åˆ° &mut u64ï¼ˆå› ä¸º Unpinï¼‰
let r: &mut u64 = Pin::get_mut(p);
```

è€Œ async future é€šå¸¸ **ä¸æ˜¯ Unpin**ï¼Œå› ä¸ºå®ƒä»¬å¯èƒ½åŒ…å«è‡ªå¼•ç”¨ã€‚

> ğŸ“ **Terminology**ï¼š
> **Unpin** è¡¨ç¤ºâ€œå³ä½¿è¢« Pin ä½ï¼Œä¹Ÿå…è®¸ç§»åŠ¨â€ã€‚Pin åªå¯¹ `!Unpin` ç±»å‹æœ‰çº¦æŸæ„ä¹‰ã€‚

### 6.5 é”™è¯¯ç¤ºä¾‹ï¼šè‡ªå¼•ç”¨ + ç§»åŠ¨å¯¼è‡´ç¾éš¾

#### é”™è¯¯ç¤ºä¾‹ Aï¼šè‡ªå¼•ç”¨ç»“æ„ä½“ï¼ˆç¼–è¯‘å™¨ç›´æ¥æ‹’ç»ï¼‰
```rust
struct SelfRef<'a> {
    buf: String,
    slice: &'a str,
}

fn bad() -> SelfRef<'static> {
    let buf = String::from("hello");
    let slice = &buf[..];
    SelfRef { buf, slice } // âŒ buf ä¸å¤Ÿé•¿ï¼Œå€Ÿç”¨æ— æ•ˆ
}
```
è¿™æ®µä»£ç æ— æ³•ç¼–è¯‘ï¼Œå› ä¸º `slice` è¯•å›¾å€Ÿç”¨ `buf`ï¼Œä½† `buf` ä¼šåœ¨è¿”å›æ—¶è¢«ç§»åŠ¨ã€‚

#### é”™è¯¯ç¤ºä¾‹ Bï¼šæ‰‹åŠ¨ç§»åŠ¨ pinned value
```rust
use std::pin::Pin;

async fn work() {}
let mut fut = Box::pin(work());

// âŒ ä¸èƒ½é€šè¿‡ replace äº¤æ¢ pinned futureï¼ˆéœ€è¦ &mut Tï¼‰
// std::mem::replace(&mut *fut, work());
```
`Pin` è®©ä½ æ‹¿ä¸åˆ° `&mut T`ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨é˜»æ­¢è¿™ç±»â€œå¯èƒ½å¯¼è‡´ç§»åŠ¨â€çš„æ“ä½œã€‚

> âš ï¸ **Gotcha**ï¼š
> Pin ä¸æ˜¯ â€œè¿è¡Œæ—¶æ£€æµ‹â€ï¼Œè€Œæ˜¯**ç¼–è¯‘æœŸé™åˆ¶**ã€‚è¦ç»•è¿‡å®ƒå¿…é¡» `unsafe`ï¼Œä¹Ÿå°±æ„å‘³ç€ä½ è¦è‡ªå·±æ‰¿æ‹…ç§»åŠ¨åæ‚¬å‚çš„è´£ä»»ã€‚

### 6.6 çœŸå®æ¡ˆä¾‹ï¼šuni-stream çš„ UDP è¶…æ—¶ä¸ Pin
åœ¨ uni-stream çš„ `UdpStreamReadHalf` ä¸­ï¼Œè¶…æ—¶è®¡æ—¶å™¨ä½¿ç”¨ `Pin<Box<Sleep>>` å­˜æ”¾ï¼š`deps/uni-stream/src/udp.rs:547`ã€‚åŸå› æ˜¯ `tokio::time::Sleep` æ˜¯ `!Unpin` ç±»å‹ï¼Œpoll/reset éƒ½éœ€è¦ `Pin<&mut Sleep>`ã€‚

çœŸå®è°ƒç”¨è·¯å¾„ï¼š
1) `impl AsyncRead for UdpStreamReadHalf` çš„ `poll_read` æ¥æ”¶ `Pin<&mut Self>` å¹¶ç›´æ¥ä¼ é€’ç»™å†…éƒ¨è¯»å–é€»è¾‘ï¼ˆ`deps/uni-stream/src/udp.rs:585`ï¼‰ã€‚  
2) `recv_datagram` åœ¨è¶…æ—¶è·¯å¾„é‡Œè°ƒç”¨ `self.timeout.as_mut()`ï¼ˆ`deps/uni-stream/src/udp.rs:615`ï¼‰ï¼Œä¹‹åè°ƒç”¨ `reset`ï¼ˆ`deps/uni-stream/src/udp.rs:639`ï¼‰ã€‚

è¿™æ„å‘³ç€ï¼š**ä¸€æ—¦ `UdpStreamReadHalf` è¢« poll è¿‡ï¼Œå®ƒé‡Œé¢çš„ `Sleep` ç»å¯¹ä¸èƒ½å†è¢«ç§»åŠ¨**ã€‚å¦åˆ™è®¡æ—¶å™¨åœ¨ runtime çš„å†…éƒ¨æŒ‡é’ˆä¼šæ‚¬å‚ã€‚

ASCII æµç¨‹å›¾ï¼š
```
poll_read()
  â””â”€â”€ impl_inner::poll_read(self: Pin<&mut UdpStreamReadHalf>)
      â””â”€â”€ timeout.poll(...) / timeout.reset(...)
          â””â”€â”€ Sleep è¢«æ³¨å†Œåˆ° runtime çš„ timer wheel
```

> ğŸ’¡ **Key Point**ï¼š
> `Pin<Box<Sleep>>` æŠŠ Sleep å›ºå®šåœ¨å †ä¸Šï¼Œåªè¦ Box ä¸è¢«ç§»åŠ¨ï¼ŒSleep çš„åœ°å€å°±ç¨³å®šï¼›å³ä½¿ `UdpStreamReadHalf` è‡ªèº«è¢«ç§»åŠ¨ï¼ŒSleep ä¹Ÿä¸ä¼šè¢«ç§»åŠ¨ã€‚

### 6.7 â€œå¦‚æœä¸ç”¨ Pin ä¼šæ€æ ·â€ï¼šçœŸå®çš„ç¼–è¯‘æŠ¥é”™åœºæ™¯
å‡è®¾æˆ‘ä»¬ç›´æ¥æŠŠ `Sleep` æ”¾åœ¨ç»“æ„ä½“é‡Œï¼Œå¹¶åœ¨ `poll_read` é‡Œè°ƒç”¨ `poll`ï¼š

```rust
use tokio::time::Sleep;
use std::pin::Pin;
use std::task::{Context, Poll};
use tokio::io::ReadBuf;

struct BadReadHalf {
    timeout: Sleep,
}

impl tokio::io::AsyncRead for BadReadHalf {
    fn poll_read(
        mut self: Pin<&mut Self>,
        cx: &mut Context<'_>,
        _buf: &mut ReadBuf<'_>,
    ) -> Poll<std::io::Result<()>> {
        // âŒ è¿™é‡Œä¼šæŠ¥é”™ï¼šSleep ä¸æ˜¯ Unpinï¼Œä¸èƒ½é€šè¿‡ &mut è°ƒç”¨ poll
        // self.timeout.poll_unpin(cx);
        Poll::Ready(Ok(()))
    }
}
```

é—®é¢˜ç‚¹åœ¨äºï¼š`Sleep` éœ€è¦ `Pin<&mut Sleep>`ï¼Œè€Œ `self.timeout` åªæ˜¯ä¸€ä¸ªæ™®é€šå­—æ®µã€‚  
å¦‚æœä½ å¼ºè¡Œæ‹¿ `&mut self.timeout`ï¼Œç¼–è¯‘å™¨ä¼šæ‹’ç»ï¼Œå› ä¸º **ä½ æ²¡æœ‰è¯æ˜æ•´ä¸ª `BadReadHalf` å·²ç»è¢«å›ºå®šåœ¨å†…å­˜åœ°å€ä¸Š**ã€‚

åœ¨ uni-stream çš„å®ç°ä¸­ï¼Œ`timeout: Pin<Box<Sleep>>` ç›´æ¥æŠŠå­—æ®µå›ºå®šï¼Œä»è€Œç»•å¼€â€œæŠ•å½± Pinâ€çš„å¤æ‚æ€§ï¼Œå¹¶ä¸”èƒ½åœ¨ `recv_datagram` é‡Œå®‰å…¨è°ƒç”¨ `reset`ã€‚  
è¿™å°±æ˜¯ `Pin` åœ¨çœŸå® async I/O ä¸­æœ€å¸¸è§çš„ç”¨æ³•ï¼š**æŠŠ `!Unpin` çš„çŠ¶æ€æœº/è®¡æ—¶å™¨å›ºå®šåœ¨å †ä¸Š**ï¼Œå†æŠŠç»“æ„ä½“å½“ä½œæ­£å¸¸å€¼ä½¿ç”¨ã€‚

> âš ï¸ **Gotcha**ï¼š
> ä½ å¯ä»¥ç”¨ `pin-project` æˆ– `unsafe` è‡ªå·±æŠ•å½± `Pin<&mut Self>` åˆ° `Pin<&mut Field>`ï¼Œä½†è¿™éœ€è¦ä½ ä¿è¯â€œå­—æ®µä¸ä¼šç§»åŠ¨â€ã€‚ç”¨ `Pin<Box<T>>` æ˜¯æ›´ç®€å•ã€ä¹Ÿæ›´å¸¸è§çš„å·¥ç¨‹åšæ³•ã€‚

### 6.8 è‡ªå¼•ç”¨ Vec çš„ frontï¼šå¦‚ä½•å®‰å…¨å¤„ç†
é—®é¢˜åœºæ™¯ï¼šä½ æƒ³åœ¨ç»“æ„ä½“é‡Œ **ä¿å­˜æŒ‡å‘ `Vec` å†…éƒ¨å…ƒç´ çš„å¼•ç”¨/æŒ‡é’ˆ**ï¼Œä¾‹å¦‚â€œæ€»æ˜¯æŒ‡å‘ `front` çš„æ•°æ®â€ã€‚

```rust
struct Bad {
    buf: Vec<u8>,
    front: *const u8, // æŒ‡å‘ buf[0]
}

impl Bad {
    fn new() -> Self {
        let mut buf = vec![1, 2, 3];
        let front = buf.as_ptr();
        Self { buf, front }
    }

    fn push(&mut self, v: u8) {
        self.buf.push(v); // å¯èƒ½è§¦å‘ reallocate -> front å¤±æ•ˆ
    }
}
```

è¿™ä¸ªä¾‹å­**ç¼–è¯‘èƒ½è¿‡**ï¼Œä½†é€»è¾‘ä¸Šä¸å®‰å…¨ï¼š`push` å¯èƒ½å¯¼è‡´ `Vec` æ‰©å®¹ï¼Œ`front` æŒ‡é’ˆæ‚¬å‚ã€‚

> âš ï¸ **Gotcha**ï¼š
> Pin åªä¿è¯ `buf` è¿™ä¸ªå­—æ®µæœ¬èº«çš„åœ°å€ä¸å˜ï¼Œ**ä¸ä¼šä¿è¯ `buf` çš„å†…éƒ¨å †å†…å­˜ä¸ç§»åŠ¨**ã€‚

å®‰å…¨å¤„ç†çš„å‡ ç§æ–¹å¼ï¼š

**æ–¹æ¡ˆ Aï¼šå­˜ç´¢å¼•ï¼Œä¸å­˜æŒ‡é’ˆ/å¼•ç”¨**ï¼ˆæœ€å®‰å…¨ã€æ¨èï¼‰  
```rust
struct Good {
    buf: Vec<u8>,
    front_idx: usize, // 0
}

impl Good {
    fn front(&self) -> Option<&u8> {
        self.buf.get(self.front_idx)
    }
}
```

**æ–¹æ¡ˆ Bï¼šå›ºå®šå®¹é‡ï¼Œç¦æ­¢æ‰©å®¹**ï¼ˆéœ€è¦ä½ å®ˆçº¦ï¼‰  
```rust
let mut buf = Vec::with_capacity(1024);
buf.extend_from_slice(&[1, 2, 3]);
let front = buf.as_ptr();
// ä¹‹ååªå…è®¸å†™å…¥ä¸è¶…è¿‡ 1024 çš„å…ƒç´ 
```
è¿™ä¸é ç±»å‹ç³»ç»Ÿä¿è¯ï¼Œéœ€è¦ä½ åœ¨é€»è¾‘ä¸Šç»´æŠ¤â€œä¸å†æ‰©å®¹â€çš„ä¸å˜é‡ã€‚

**æ–¹æ¡ˆ Cï¼šæŠŠå…ƒç´ å•ç‹¬å›ºå®š**ï¼ˆç¨³å®šåœ°å€ï¼‰  
```rust
let mut buf: Vec<Pin<Box<u8>>> = Vec::new();
buf.push(Box::pin(1));
let front: *const u8 = &*buf[0]; // å…ƒç´ åœ°å€ç¨³å®š
```

**æ–¹æ¡ˆ Dï¼šè½¬æˆä¸å¯å¢é•¿çš„åˆ‡ç‰‡**  
```rust
let buf = vec![1,2,3].into_boxed_slice(); // Box<[u8]>
let front = buf.as_ptr();
// ä¸å¯å† pushï¼Œåœ°å€ç¨³å®š
```

> ğŸ’¡ **Key Point**ï¼š
> åªè¦ä½ éœ€è¦â€œå†…éƒ¨å…ƒç´ åœ°å€ç¨³å®šâ€ï¼Œå°±ä¸èƒ½ä¾èµ–æ™®é€š Vec çš„ pushï¼›è¦ä¹ˆé¿å…è‡ªå¼•ç”¨ã€è¦ä¹ˆä¿è¯ä¸æ‰©å®¹ã€è¦ä¹ˆæŠŠå…ƒç´ ç‹¬ç«‹å›ºå®šã€‚

---

## 7. ä¸ºä»€ä¹ˆ Box ä¹‹åæ›´â€œå®¹æ˜“â€é€šè¿‡

### 7.1 Box å¹¶ä¸ä¼šå…é™¤ Send è¯æ˜
`Box<dyn Future + Send>` **ä»ç„¶è¦æ±‚å†…éƒ¨ future æ˜¯ Send**ã€‚æˆ‘ä»¬æ­¤å‰å·²ç»é‡åˆ°â€œboxed ä»ç„¶æç¤º future !Sendâ€çš„æŠ¥é”™ã€‚

Box çš„ä½œç”¨æ˜¯ï¼š
- **ç±»å‹æ“¦é™¤**ï¼ˆtrait objectï¼‰
- **é¿å…å¤æ‚ç”Ÿå‘½å‘¨æœŸ/æ³›å‹æ¨å¯¼**ï¼ˆå•ç‚¹è¯æ˜ï¼‰

### 7.2 ä¸ºä»€ä¹ˆ RPITITï¼ˆasync fn in traitï¼‰ä¼šæ‰é“¾å­
> ğŸ“ **Terminology**ï¼š
> **RPITIT** = *Return Position Impl Trait In Trait*ï¼ŒæŒ‡åœ¨ trait æ–¹æ³•è¿”å›ä½ç½®å†™ `-> impl Trait`ã€‚  
> **async fn in trait** æ˜¯ RPITIT çš„è¯­æ³•ç³–ï¼šå®ƒä¼šè¢«ç¼–è¯‘å™¨â€œé™ç³–â€ä¸ºè¿”å›ä¸€ä¸ª **opaque future** çš„ `-> impl Future`ã€‚

`async fn in trait` ä¼šç”Ÿæˆ **opaque future**ï¼Œå¹¶ä¸”å¯¹æ³›å‹ç”Ÿå‘½å‘¨æœŸéœ€è¦â€œå…¨ç§°è¯æ˜â€ã€‚
å½“ future æ•è· `ReadHalf<'a>` / `WriteHalf<'a>` è¿™ç±»å€Ÿç”¨æ—¶ï¼Œç¼–è¯‘å™¨å¾ˆéš¾è¯æ˜ï¼š
> å¯¹ä»»æ„ `'a`ï¼Œè¯¥ future éƒ½æ˜¯ Sendã€‚

è¿™å°±æ˜¯ä¹‹å‰å‡ºç° â€œlifetime bound not satisfied / AsyncRead not general enoughâ€ çš„æ ¸å¿ƒåŸå› ã€‚

> ğŸ’¡ **Key Point**ï¼š
> æˆ‘ä»¬æŠŠ RPITIT å’Œ async fn in trait æ”¾åœ¨ä¸€èµ·ï¼Œæ˜¯å› ä¸º**åè€…å°±æ˜¯å‰è€…åœ¨ async åœºæ™¯ä¸‹çš„å…·ä½“å½¢æ€**ã€‚

> ğŸ’¡ **Key Point**ï¼š
> è¿™ä¸æ˜¯â€œå®é™…ä¸å®‰å…¨â€ï¼Œè€Œæ˜¯ **ç±»å‹ç³»ç»Ÿå½“å‰æ¨å¯¼èƒ½åŠ›çš„é™åˆ¶**ã€‚

> â­ï¸ è¿™ç±»é™åˆ¶åœ¨å·¥ç¨‹ä¸Šé€šå¸¸é€šè¿‡ â€œboxed futureâ€ æˆ– â€œowned halvesâ€ è§„é¿ï¼Œä¸‹ä¸€èŠ‚ç›´æ¥è½åœ°åˆ° split/into_splitã€‚

---

## 8. å€Ÿç”¨ split vs owned splitï¼ˆ`into_split` çš„æ„ä¹‰ï¼‰

### 8.1 å€Ÿç”¨ split çš„ç‰¹ç‚¹
- `split()` å¾—åˆ°çš„æ˜¯ **å€Ÿç”¨åŠè¾¹**ï¼ˆ`ReadHalf<'a>`ï¼‰
- åªèƒ½åœ¨å½“å‰ä»»åŠ¡å†… `.await`
- æ— æ³•ç›´æ¥ `spawn`

### 8.2 owned split çš„ç‰¹ç‚¹
- `into_split()` å¾—åˆ°çš„æ˜¯ **owned halves**ï¼ˆ`OwnedReadHalf`ï¼‰
- æ»¡è¶³ `'static`ï¼Œæ›´å®¹æ˜“æ»¡è¶³ `Send + 'static`
- å¯ä»¥å®‰å…¨ä¸¢ç»™ `tokio::spawn`

åœ¨ uni-stream ä¸­ï¼Œæˆ‘ä»¬å·²ç»æ·»åŠ äº†è¿™ä¸ªæ¥å£ï¼š
- `StreamSplit::into_split`ï¼ˆ`deps/uni-stream/src/stream.rs:20`ï¼‰
- TCP å®ç°ä¸ UDP å®ç°ï¼ˆ`deps/uni-stream/src/stream.rs:98`ï¼‰
- UDP owned halves ä¸ guard ç»“æ„ï¼ˆ`deps/uni-stream/src/udp.rs:458`ï¼‰

> ğŸ“ **Terminology**ï¼š
> **Owned halves** æŒ‡çš„æ˜¯è¯»å†™åŠè¾¹â€œæ‹¥æœ‰åº•å±‚èµ„æºâ€ï¼Œä¸å†ä¾èµ–å¤–éƒ¨å€Ÿç”¨ã€‚

---

## 9. ç»“åˆ pb-mapper çš„å®æˆ˜è§£è¯»

### 9.1 ä¸ºä»€ä¹ˆ `StreamForward` è¦è¿”å› `Pin<Box<dyn Future + Send>>`
`StreamForward` è¢« `tokio::spawn` çš„è·¯å¾„é—´æ¥è°ƒç”¨ï¼Œå› æ­¤è¿”å› future å¿…é¡» `Send`ã€‚
æˆ‘ä»¬ç”¨ Box æ¥è§„é¿ RPITIT å¯¹ç”Ÿå‘½å‘¨æœŸ/Send è¯æ˜çš„æ¨å¯¼é™åˆ¶ã€‚

å‚è€ƒï¼š`src/common/message/forward.rs:311`ã€‚

### 9.2 å¦‚æœæœªæ¥è¦â€œé›¶åˆ†é…â€æ€ä¹ˆåŠ
è¦åšåˆ°çœŸæ­£çš„â€œé›¶åˆ†é… + spawnâ€ï¼Œå¿…é¡»ï¼š
- ä½¿ç”¨ `into_split()` è·å– owned halvesï¼ˆ`'static`ï¼‰
- é¿å… trait-level `async fn` çš„ opaque future æ¨å¯¼é—®é¢˜
- åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ç”¨ `impl Future + Send + 'static` è¿”å›å€¼

å¦åˆ™ä¸€æ—¦ç‰µæ‰¯å€Ÿç”¨åŠè¾¹ï¼Œå°±ä¼šå›åˆ° RPITIT é™åˆ¶ä¸ `tokio::spawn` å†²çªçš„é—®é¢˜ã€‚

---

## 10. è®¾è®¡æƒè¡¡ä¸å®è·µå»ºè®®

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ä»£ä»· | é€‚ç”¨åœºæ™¯ |
|---|---|---|---|
| `split()` + ç›´æ¥ `.await` | é›¶æ‹·è´ï¼Œç®€å• | ä¸èƒ½ spawn | åŒä¸€ä»»åŠ¡å†…å¤„ç† |
| `split()` + Box | å¯ spawnï¼ˆç±»å‹æ“¦é™¤ï¼‰ | å †åˆ†é… | éœ€è¦ spawn + å€Ÿç”¨åŠè¾¹ |
| `into_split()` + spawn | å¯ spawnï¼Œ'static | éœ€è¦ owned halves | é«˜å¹¶å‘ã€è·¨çº¿ç¨‹ |

> âš ï¸ **Gotcha**ï¼š
> å¦‚æœä½ çœ‹åˆ° `Send` æŠ¥é”™ï¼Œä¸è¦ç¬¬ä¸€æ—¶é—´æ€ªæ•°æ®ç»“æ„ï¼Œè€Œæ˜¯å…ˆæ£€æŸ¥ï¼š
> 1) ä½ çš„ future æ˜¯å¦è¢« `spawn` åŒ…è£¹ï¼›
> 2) æ˜¯å¦æ•è·äº†é `'static` å€Ÿç”¨ï¼›
> 3) æ˜¯å¦è§¦å‘äº† RPITIT çš„æ¨å¯¼é™åˆ¶ã€‚

---

## 11. Code Indexï¼ˆå¯ç›´æ¥è·³è½¬ï¼‰
- `src/local/client/mod.rs:164`ï¼ˆclient ä¾§ spawnï¼‰
- `src/local/server/mod.rs:309`ï¼ˆserver ä¾§ spawnï¼‰
- `src/common/message/forward.rs:311`ï¼ˆStreamForward è¿”å› boxed Send futureï¼‰
- `deps/uni-stream/src/stream.rs:20`ï¼ˆStreamSplit + into_split å…³è”ç±»å‹ï¼‰
- `deps/uni-stream/src/udp.rs:458`ï¼ˆUDP owned halves + guardï¼‰

---

## 12. References
- Rust async/await è¯­ä¹‰ï¼ˆç¼–è¯‘ä¸ºçŠ¶æ€æœºï¼‰
- Tokio `spawn` çš„ `Send + 'static` çº¦æŸ

> æ³¨ï¼šæœ¬æ–‡æ‰€æœ‰ä»£ç å¼•ç”¨å‡æ¥è‡ªæœ¬ä»“åº“ä¸Šè¿°æ–‡ä»¶è·¯å¾„ä¸è¡Œå·ã€‚
